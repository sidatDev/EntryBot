
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- CORE: DOCUMENT MANAGEMENT ---

model Document {
  id            String   @id @default(cuid())
  name          String
  url           String
  type          String   // e.g., 'image/png', 'application/pdf'
  size          Int
  
  status        String   @default("PENDING") // PENDING, PROCESSING, REVIEW_REQUIRED, COMPLETED
  approvalStatus String? @default("PENDING") // PENDING, APPROVED, REJECTED
  extractedText String?  @db.Text
  
  // New: Categorization
  category      String?  @default("General") // e.g., Invoice, Receipt, Contract
  source        String?  @default("UPLOAD") // UPLOAD, SPLIT, MERGE
  tags          Tag[]
  
  // Relations
  uploaderId    String?
  user          User?    @relation(fields: [uploaderId], references: [id])
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  assignedToId  String?
  assignedTo    User?    @relation("AssignedDocuments", fields: [assignedToId], references: [id])
  
  // Extracted Entities
  invoices       Invoice[]
  bankStatement  BankStatement? // One-to-One
  
  qualityReview  QualityReview?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
}


// --- CORE: AUTHENTICATION & RBAC ---

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  passwordHash   String
  
  role           String   @default("ENTRY_OPERATOR") // ADMIN, MANAGER, ENTRY_OPERATOR, VIEWER
  status         String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  
  // Custom Role (Optional)
  customRoleId   String?
  customRole     Role?    @relation(fields: [customRoleId], references: [id])
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Relations
  documents      Document[] // Uploaded documents
  assignedDocs   Document[] @relation("AssignedDocuments") // Assigned documents
  teams          Team[]   @relation("TeamMembers")
  
  auditLogs      AuditLog[]
  reviews        QualityReview[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Organization {
  id            String   @id @default(cuid())
  name          String
  type          String   @default("CLIENT") // MASTER_CLIENT, SUB_CLIENT, INTERNAL
  status        String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  credits       Int      @default(0)

  parentId      String?
  parent        Organization? @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children      Organization[] @relation("OrganizationHierarchy")
  
  users         User[]
  documents     Document[]
  teams         Team[]
  subscription  Subscription?
  auditLogs     AuditLog[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}


// --- DATA EXTRACTION MODELS ---

model Invoice {
  id            String   @id @default(cuid())
  type          String   // SALES, PURCHASE
  status        String   @default("DRAFT") // DRAFT, SAVED
  
  invoiceNumber String?
  date          DateTime?
  dueDate       DateTime?
  
  supplierName  String?
  customerName  String?
  
  subTotal      Float?
  taxTotal      Float?
  totalAmount   Float?
  currency      String   @default("USD")

  paymentMethod      String?
  
  // Conversion / Base Currency Fields
  invoiceCurrency    String   @default("USD")
  exchangeRate       Float?   @default(1.0)
  baseSubTotal       Float?
  baseTaxTotal       Float?
  baseVatRate        Float?   @default(0)
  baseCurrencyAmount Float? // Gross in Base Currency
  
  vatRate            Float?   @default(0)
  
  notes              String?
  
  documentId    String
  document      Document @relation(fields: [documentId], references: [id])
  
  items         LineItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model LineItem {
  id          String   @id @default(cuid())
  description String
  quantity    Float    @default(1)
  unitPrice   Float    @default(0)
  total       Float    @default(0)
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

model BankStatement {
  id            String   @id @default(cuid())
  documentId    String   @unique
  document      Document @relation(fields: [documentId], references: [id])
  
  accountTitle  String?
  accountNumber String?
  iban          String?
  currency      String   @default("USD")
  address       String?
  
  fromDate      DateTime?
  toDate        DateTime?
  
  openingBalance Float?  @default(0)
  closingBalance Float?  @default(0)
  
  transactions  BankTransaction[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model BankTransaction {
  id              String        @id @default(cuid())
  bankStatementId String
  bankStatement   BankStatement @relation(fields: [bankStatementId], references: [id], onDelete: Cascade)
  
  bookingDate     DateTime?
  description     String?
  
  credit          Float?   @default(0)
  debit           Float?   @default(0)
  availableBalance Float?  @default(0)
  
  createdAt       DateTime @default(now())
}


model Tag {
  id    String @id @default(cuid())
  name  String @unique
  
  documents Document[]
}


// --- QA & AUDITING ---

model QualityReview {
  id          String   @id @default(cuid())
  
  documentId  String   @unique
  document    Document @relation(fields: [documentId], references: [id])
  
  reviewerId  String
  reviewer    User     @relation(fields: [reviewerId], references: [id])
  
  status      String   @default("PASSED") // PASSED, FAILED
  notes       String?
  errorCode   String?  // DATA_MISMATCH, SPELLING, MISSING_FIELD
  
  createdAt   DateTime @default(now())
}

model Subscription {
  id             String   @id @default(cuid())
  organizationId String   @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  plan           String   @default("FREE")
  status         String   @default("ACTIVE")
  
  packageId      String?
  package        Package? @relation(fields: [packageId], references: [id])

  startDate      DateTime @default(now())
  endDate        DateTime?
  renewalDate    DateTime?
  remainingCredits Int @default(0)
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions String   @db.Text // JSON list of permissions e.g. ["invoices.view", "users.manage"]
  isSystem    Boolean  @default(false)
  
  users       User[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Package {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String?
  price          Float
  monthlyCredits Int
  
  subscriptions  Subscription[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Team {
  id             String   @id @default(cuid())
  name           String
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  members        User[]   @relation("TeamMembers")
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model AuditLog {
  id             String   @id @default(cuid())
  action         String   // LOGIN, DOC_UPLOAD, DOC_APPROVE
  
  userId         String?
  user           User?    @relation(fields: [userId], references: [id])
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  entityId       String?  // ID of Document, User, etc.
  details        String?  // JSON details
  
  ipAddress      String?
  createdAt      DateTime @default(now())
}
