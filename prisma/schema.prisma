// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ORGANIZATION HIERARCHY ---
model Organization {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String   @default("CHILD_CLIENT") // MASTER_CLIENT, CHILD_CLIENT, INTERNAL
  
  // Hierarchy
  parentId    String?
  parent      Organization? @relation("OrgHierarchy", fields: [parentId], references: [id])
  children    Organization[] @relation("OrgHierarchy")

  // Settings & Credits
  status      String   @default("ACTIVE") // ACTIVE, TRIAL, BLOCKED
  credits     Int      @default(0) // Available processing credits
  
  users       User[]
  documents   Document[]
  
  subscription Subscription?
  teams        Team[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  
  // Improved Role System
  role      String   @default("SUBMITTER") // Legacy fallback
  
  // Organization Link
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Custom Role (Granular Permissions)
  customRoleId String?
  customRole   Role?   @relation(fields: [customRoleId], references: [id])

  status       String  @default("ACTIVE") // ACTIVE, INACTIVE
  integrationStatus String @default("NONE") // NONE, XERO, QUICKBOOKS

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?

  submittedDocuments   Document[] @relation("DocumentSubmitter")
  approvedDocuments    Document[] @relation("DocumentApprover")
  auditLogs            AuditLog[]

  // Phase 2: Team & QA
  teamId       String?
  team         Team?       @relation("TeamMembers", fields: [teamId], references: [id])
  reviews      QualityReview[]
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // SUPER_ADMIN, MASTER_ADMIN, DATA_ENTRY, etc.
  description String?
  permissions String   // JSON: ["doc.create", "org.view", "user.manage"]
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  
  users       User[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // USER_LOGIN, DOC_UPLOAD, DOC_DELETE
  details   String?  // JSON details
  ipAddress String?
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
}

// --- DOCUMENT MANAGEMENT ---
model Document {
  id        String   @id @default(cuid())
  name      String
  url       String   
  size      Int
  type      String   // PDF, IMG
  category  String   @default("GENERAL") 
  extractedText String? 
  status    String   @default("UPLOADED") // UPLOADED, PENDING_ENTRY, PROCESSING, QA_REVIEW, COMPLETED, REJECTED
  source    String   @default("WEB")      
  
  // Ownership
  userId    String
  user      User     @relation(fields: [userId], references: [id], name: "DocumentSubmitter")
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // Workflow
  assignedToId   String?  // User ID of Data Entry person processing this
  qaStatus       String   @default("NONE") // NONE, PASSED, FAILED

  // Approval Legacy
  approvalStatus   String   @default("PENDING") 
  approverId       String?
  approver         User?    @relation(fields: [approverId], references: [id], name: "DocumentApprover", onDelete: SetNull)
  approvalDate     DateTime?
  rejectionReason  String?
  comments         String?
  
  // Phase 2: QA
  qualityReview QualityReview?

  invoices       Invoice[]
  bankStatement  BankStatement?
  tags           Tag[]
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}

model Invoice {
  id            String   @id @default(cuid())
  type          String   // SALES, PURCHASE
  status        String   @default("DRAFT") // DRAFT, SAVED
  
  invoiceNumber String?
  date          DateTime?
  dueDate       DateTime?
  
  supplierName  String?
  customerName  String?
  
  subTotal      Float?
  taxTotal      Float?
  totalAmount   Float?
  currency      String   @default("USD")

  paymentMethod      String?
  baseCurrencyAmount Float?
  exchangeRate       Float?   @default(1.0)
  
  documentId    String
  document      Document @relation(fields: [documentId], references: [id])
  
  items         LineItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model LineItem {
  id          String   @id @default(cuid())
  description String
  quantity    Float    @default(1)
  unitPrice   Float    @default(0)
  total       Float    @default(0)
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

model BankStatement {
  id            String   @id @default(cuid())
  displayName   String?
  statementType String   @default("BANK")
  
  accountInfo   String?
  last4Digits   String?
  currency      String   @default("GBP")
  
  startDate     DateTime?
  endDate       DateTime?
  
  status        String   @default("PROCESSING")
  
  documentId    String   @unique
  document      Document @relation(fields: [documentId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Tag {
  id    String @id @default(cuid())
  name  String @unique
  
  documents Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- PHASE 2: SUBSCRIPTIONS & COMMERCIALIZATION ---

model Package {
  id             String   @id @default(cuid())
  name           String   @unique // e.g., "Silver", "Gold"
  price          Float
  monthlyCredits Int
  description    String?

  subscriptions  Subscription[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Subscription {
  id             String       @id @default(cuid())
  
  organizationId String       @unique // One active sub per org
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  packageId      String
  package        Package      @relation(fields: [packageId], references: [id])
  
  status         String       @default("ACTIVE") // ACTIVE, PAST_DUE, CANCELED
  startDate      DateTime     @default(now())
  endDate        DateTime?    // Null means indefinite/auto-renew
  
  remainingCredits Int        @default(0) // Credits tailored to this sub period

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// --- PHASE 2: TEAM & QA MANAGEMENT ---

model Team {
  id             String       @id @default(cuid())
  name           String
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  users          User[]       @relation("TeamMembers")
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model QualityReview {
  id             String       @id @default(cuid())
  
  documentId     String       @unique
  document       Document     @relation(fields: [documentId], references: [id])
  
  reviewerId     String
  reviewer       User         @relation(fields: [reviewerId], references: [id])
  
  status         String       // PASSED, FAILED, NEEDS_CORRECTION
  score          Int?         // 1-100
  notes          String?
  
  createdAt      DateTime     @default(now())
}




